// Source produces a dynamically allocated struct, which it passes
// to Print. Reference counting ensures that the struct is freed.
target CCpp;
reactor StructPrint {
    preamble {=
        struct hello_t {
            char* name;
            int value;
        };
    =}
    output out:hello_t*;
    reaction(startup) -> out {=
        // Dynamically allocate an output struct.
        SET_NEW(out);
        // Above allocates a struct, which then must be populated.
        out->value->name = "Earth";
        out->value->value = 42;
    =}
}

// expected parameter is for testing.
reactor Print(expected:int(42)) {
    input in:hello_t*;
    reaction(in) {=
        std::cout << "Received: name" << in->value->name << ", value = " << in->value->value << std::endl;
        if (in->value->value != self->expected) {
            std::cerr << "ERROR: Expected value to be " << self->expected << std::endl;
            exit(1);
        }
    =}
}
main reactor StructPrintTest {
    s = new StructPrint();
    p = new Print();
    s.out -> p.in;
}
